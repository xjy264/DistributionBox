# DistributionBox — 需求文档（v1.1）

> 目标：从零开始重写“配电箱管理系统”，在实现上**借鉴** `old-box/` 中的现有思路与页面结构，但不沿用旧系统的技术债与不清晰设计。

## 0. 文档信息
- 版本：v1.1
- 状态：草案
- 更新时间：2026-02-04
- 参考：`../.. /old-box`（旧代码，仅借鉴）

## 1. 背景与范围
### 1.1 背景
配电箱（Distribution Box / Panel）在园区/楼宇/工厂中分布广，维护依赖纸质台账、人工巡检与经验。需要一个系统将“资产—回路—用电设备—巡检维保—故障处置”串起来。

### 1.2 范围（本期做什么）
- 配电箱资产台账
- 回路/断路器（位号、额定参数、去向）管理
- 巡检与维保记录
- 故障/隐患记录与闭环
- 基础权限与审计（最小可用）

### 1.3 非范围（本期不做什么）
- 实时采集/IoT 上报（可预留接口）
- 复杂工单流转/备件仓储
- 多租户/跨组织级的复杂权限模型（先做简单版）

## 2. 角色与权限（v1.1）
- 管理员（Admin）：系统配置、用户与权限、全量数据
- 运维主管（Manager）：查看全部、分配任务（v1.1 可先不做分配）
- 运维人员（Technician）：录入巡检/维保/故障，查看授权范围
- 只读（Viewer）：仅查看

> v1.1 权限建议：先用“角色 + 菜单权限”实现，数据范围先全局或按站点/区域二选一。

## 3. 核心对象（数据模型草案）
### 3.1 配电箱（distribution_box）
- 编号/名称
- 位置（园区/楼栋/楼层/房间/经纬度可选）
- 型号/厂家/出厂编号
- 额定电压/额定电流/进线方式
- 投运日期、状态（在用/停用/检修）
- 图片/附件

### 3.2 回路/断路器（circuit / breaker）
- 所属配电箱
- 位号/回路号
- 用途/去向（区域/设备）
- 额定电流/漏保参数
- 当前状态（合/分/未知）
- 标签（二维码/条码 可选）

### 3.3 巡检记录（inspection）
- 配电箱/回路维度
- 巡检时间、巡检人
- 项目勾选（温度、异响、异味、指示灯、接线端子、清洁等）
- 发现问题（可关联隐患/故障）
- 图片/附件

### 3.4 维保记录（maintenance）
- 维保时间、维保人
- 维保项（紧固、除尘、测试、替换元件…）
- 结果、备注、附件

### 3.5 故障/隐患（issue）
- 类型：故障 / 隐患
- 级别：一般/重要/紧急
- 位置：配电箱 +（可选回路）
- 描述、发现时间、发现人
- 状态：待处理/处理中/已解决/已关闭
- 处理过程、结论、复验

### 3.6 用户与审计
- 用户、角色
- 审计日志：登录、增删改、导入导出等关键操作

## 4. 功能清单（v1.1 最小可用）
### 4.1 配电箱台账
- 列表：筛选（位置/状态/关键字）、分页
- 新增/编辑/删除（软删优先）
- 详情页：基本信息 + 回路列表 + 最近巡检/故障
- 附件：图片上传与查看

### 4.2 回路管理
- 在配电箱详情中维护回路
- 回路列表：支持快速编辑位号、额定电流、去向

### 4.3 巡检
- 新增巡检：选择配电箱（可选回路），填写检查项
- 巡检记录列表/详情

### 4.4 故障/隐患闭环
- 新增问题、状态流转、处理记录
- 与巡检记录互相关联

### 4.5 权限（简单版）
- 登录/退出
- 角色控制页面访问

## 5. 页面/路由（建议）
- 登录
- 配电箱管理
  - 列表
  - 新增/编辑
  - 详情（含回路）
- 巡检管理
  - 新增
  - 列表/详情
- 故障/隐患
  - 列表
  - 详情（处理记录）
- 系统管理
  - 用户/角色（v1.1 可先只做 Admin 内置）

## 6. 交互与非功能要求
- 操作尽量表单化、可快速录入（移动端适配优先级：中）
- 附件上传需限制大小/类型；图片压缩可选
- 关键操作留痕（审计）
- 数据导入导出（v1.1：先不做，v1.2 考虑）

## 7. old-box 迁移/提取需求（v1.1 必做）
> 目标：**从零开始写**新系统，但要把 `old-box/` 里已经验证过的“主要逻辑/功能模块/页面信息架构”提取出来。

### 7.1 需要从 old-box 提取的核心模块（候选清单）
（基于现有代码扫描得到，供你选择）
- 权限/分权：用户登录 + JWT；角色(Role)；菜单(Menu)；角色-菜单绑定(RoleMenu)
- 配电箱管理：Box（配电箱）相关增删改查、分页、详情
- 巡检/检测：Inspection、Detect、Check（巡检表单/检查项）
- 维保/故障处理：Maintenance、Fix（以及相关记录）
- 组件/备件：Components
- 附件/图片上传：Files（upload、下载/访问、分页）
- 数据统计：Echarts（图表接口）
- 打印/导出：BoxController 里存在 `print/{id}` 之类能力（待确认是否要保留）

### 7.2 字段冻结原则（强约束）
- **不得修改你已有的数据字段**：字段名、含义、必填性不能随意改。
- 若新需求需要新增字段：
  - 只能 **新增**（不改旧字段）
  - 必须在该版本需求文档中明确列出（字段名、类型、默认值、是否可空、迁移策略）

### 7.3 迁移策略（建议）
- 前端：旧项目为 Vue2 + Element-UI，新项目为 Vue3 + Element Plus。
  - 允许“按页面重写迁移”，但页面功能与字段展示必须对齐。
- 后端：旧项目 Spring Boot + MyBatis Plus + JWT 拦截器。
  - 新项目可以继续 MyBatis Plus 或切 JPA，但字段/表结构需严格对齐。

## 8. 待确认问题（请你回答）
已确认（来自你 2026-02-04 的指示）：
- 允许修正不规范点，不需要沿用 old-box 风格
- 前端：Vue 3
- 后端：Java 21
- 字段：以 `old-box/src/main/java/com/xjy/shujia/entity/*.java` 为准（字段冻结）
- 文件上传：沿用 old-box 原有路径规则

已确认（来自你 2026-02-04 23:21 的指示）：
1) **功能范围**：全部模块保留（old-box 的所有 controller/页面模块都需要在新系统中重写并可用）。
2) **数据库**：MySQL 8.0。
3) **文件上传**：保留 `files` 的目录结构（具体落盘根目录待你提供/我给默认值再让你确认）。
4) **初始化账号**：预置管理员 `admin/admin`。
5) **权限菜单**：采用“最新方案”（不强行保留旧的‘登录返回 menus + 动态路由’实现细节，但功能等价，菜单与权限可配置）。

仍待确认（开始写代码前必须明确）：
- 文件上传落盘根路径：确认使用项目根目录下 `./files/`（保留目录结构）。
- 初始化账号：你将直接操作数据库加入用户（我不在代码里强制创建 admin）。

## 9. 交付约束（开发过程规范）
1) 每实现/迁移一个功能模块：
   - 必须同步更新需求文档（本文件 or 新增 v1.1.x 补丁文档）
   - 必须同步维护 SQL（建表/变更/种子数据），确保可从 0 初始化
2) 鉴权方案：后端 Spring Security 统一做 API 鉴权，前端菜单仅用于展示/过滤（不依赖“隐藏菜单”来保证安全）。

## 10. 实施计划与检查清单（v1.1）
> 说明：以下为实现顺序建议与模块级完成清单；每完成一个模块需同步更新本节与开发变更记录。

### 10.1 实施计划（高层）
1) 基础设施：后端/前端工程脚手架、统一配置、通用异常/响应、日志、Swagger/OpenAPI、JWT、RBAC、Flyway、MySQL、Docker Compose。
2) 权限与组织基础：登录/用户/角色/菜单/角色菜单、部门。
3) 业务主模块：配电箱、组件、巡检/检测/检查、记录、维保、故障修复、附件文件。
4) 业务支撑模块：课程、税务、首页/统计、图表、地图/站点/人员页面。
5) 质量收尾：联调校验、基础构建命令验证、文档与 done 总结。

### 10.2 模块级检查清单（必须全覆盖）
- Auth：登录/退出、JWT、RBAC、会话与权限校验
- 用户(User)
- 角色(Role)
- 菜单(Menu)
- 角色菜单(RoleMenu)
- 部门(Department)
- 配电箱(Box)
- 组件/备件(Components)
- 巡检(Inspection)
- 检测(Detect)
- 检查(Check)
- 记录(Record)
- 维保(Maintenance)
- 故障修复(Fix)
- 文件/附件(Files)
- 课程(Course)
- 税务(Tax)
- 首页(Home)
- 统计图表(Echarts)
- 地图/站点/人员页面（按 old-box 前端路由/页面落实）

### 10.3 基础工程检查清单（必须完成）
- 后端：Spring Boot 3 + Java 21 + Maven + MySQL 8 + Flyway + Spring Security + JWT + OpenAPI
- 前端：Vue 3 + Vite + TypeScript + Element Plus + Pinia + Router
- Docker：MySQL 8 docker-compose
- 目录：`/backend`、`/frontend`、`/files` 落地
- README：启动/配置步骤

## 11. 实施完成记录（v1.1）
### 11.1 已实现模块
- Auth：登录/退出、JWT、RBAC 基础
- 用户(User)
- 角色(Role)
- 菜单(Menu)
- 角色菜单(RoleMenu)
- 部门(Department)
- 配电箱(Box)
- 组件/备件(Components)
- 巡检(Inspection)
- 检测(Detect)
- 检查(Check)
- 记录(Record)
- 维保(Maintenance)
- 故障修复(Fix)
- 文件/附件(Files)
- 课程(Course) + 选课关联(StudentCourse)
- 税务(Tax)
- 首页(Home)
- 统计图表(Echarts)
- 地图/站点/人员页面

### 11.2 对应迁移文件
- V1__create_sys_user.sql
- V2__create_sys_role.sql
- V3__create_sys_menu.sql
- V4__create_sys_role_menu.sql
- V5__create_sys_department.sql
- V6__create_sys_box.sql
- V7__create_sys_components.sql
- V8__create_sys_inspection.sql
- V9__create_sys_detect.sql
- V10__create_sys_check.sql
- V11__create_sys_record.sql
- V12__create_sys_maintenance.sql
- V13__create_sys_fix.sql
- V14__create_sys_files.sql
- V15__create_course.sql
- V16__create_student_course.sql
- V17__create_sys_tax.sql
- V18__create_sys_home.sql
- V19__create_sys_dict.sql
