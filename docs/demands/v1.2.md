# DistributionBox — 需求文档（v1.2）

> v1.2 主题：修复“最高权限用户点击侧边栏【用户管理】被错误跳转到登录页”的路由/鉴权问题。

## 0. 文档信息
- 版本：v1.2
- 状态：待实现
- 更新时间：2026-02-11
- 关联系统：配电箱管理系统（`~/project/distributionbox`）
- 上一版本：`docs/demands/v1.1.md`

---

## 1. 问题背景
当前系统中，已配置最高权限用户（管理员）登录后，点击侧边栏【用户管理】菜单，会被系统重定向到 `/login` 登录页。

这表明在“路由守卫 / token 校验 / 动态路由注入 / 菜单权限映射 / 后端 401/403 处理”中的至少一环存在缺陷，导致管理员访问合法页面时被当作未登录或无权限。

---

## 2. 需求目标
### 2.1 业务目标
确保“最高权限用户”在登录后可稳定访问【用户管理】页面，不发生错误重定向到登录页。

### 2.2 技术目标
通过 Codex 完成以下工作：
1. 全链路排查该问题（前端路由 + 前端鉴权 + 后端鉴权 + 接口返回码 + 菜单配置）。
2. 给出根因说明（可复现、可解释）。
3. 完成修复并验证。
4. 输出修复记录与验证证据。

---

## 3. 范围
### 3.1 本次必须覆盖
- 登录态保持与 token 读取
- 前端路由守卫（例如 `beforeEach`）
- 动态路由注册时机与白名单
- 侧边栏菜单到路由 path 的映射一致性
- 后端用户管理相关接口的权限注解/拦截规则
- 401/403 响应处理策略（避免把“无权限/接口异常”误判为“未登录”）

### 3.2 本次不做
- 权限模型重构
- 菜单体系大改
- 与该问题无关的页面重构

---

## 4. 现象定义（复现步骤）
1. 使用最高权限账号登录系统。
2. 在左侧导航点击【用户管理】。
3. 实际结果：跳转到 `/login`。
4. 期望结果：进入【用户管理】页面并正常加载用户列表。

---

## 5. 验收标准（最终输出结果）
以下条件全部满足才算完成：

1. **功能通过**
   - 最高权限用户点击【用户管理】后，始终进入目标页（不跳 `/login`）。

2. **接口通过**
   - 用户管理相关接口返回符合预期（管理员不应出现误判 401）。

3. **回归通过**
   - 刷新页面后仍保持登录态与可访问性。
   - 退出登录后访问受保护页面，才会被重定向到 `/login`（行为正确）。

4. **文档输出完整**
   - 根因说明（1-2 个主要原因，避免模糊描述）。
   - 修复点清单（涉及文件路径、关键逻辑）。
   - 验证步骤与结果。

---

## 6. 给 Codex 的执行要求（督办指令）

### 6.1 工作方式
- 先排查再修改，禁止盲改。
- 修改范围最小化，优先精准修复。
- 不改变既有业务字段与核心权限模型（遵循 v1.1 约束）。

### 6.2 交付物
Codex 完成后需提交：
1. 变更文件列表。
2. 根因分析。
3. 修复说明。
4. 本地验证记录（至少包含：登录 -> 点击用户管理 -> 结果）。
5. 如有新增 TODO，必须显式列出。

---

## 7. 风险与注意事项
- 若前端把所有 401/403 一律重定向登录，可能掩盖真实权限问题。
- 若动态路由在页面刷新后未重新注入，会导致“有菜单无路由”并触发兜底跳转。
- 若菜单 path 与前端实际 route name/path 不一致，会触发守卫误判。

---

## 8. 已确认约束（2026-02-11）
1. 路由 path 由实现方通过代码自行核对定位（不依赖口头猜测）。
2. 允许在本地通过命令行连接 MySQL 排查数据与权限配置。
3. 当前“点击用户管理跳登录”问题为**每次必现**。
4. 修复完成后，必须把 Codex 产出的“做了什么 + 为什么这么做 + 改了哪些文件 + 验证结果”同步回本需求文档。

## 9. 执行后文档回填模板（给 Codex）
### 9.1 根因
- 根因1：
- 根因2（如有）：

### 9.2 修复动作
- 文件A：
- 文件B：
- 关键逻辑：

### 9.3 验证结果
- 用例1（管理员登录后点击用户管理）：
- 用例2（刷新后再次进入用户管理）：
- 用例3（退出后访问受保护路由应跳登录）：

### 9.4 风险与后续建议
- 
