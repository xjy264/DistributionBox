# DistributionBox — 执行结果归档（v1.8）

- 对应需求：v1.8
- 执行时间：2026-02-12

## 1) 根因 / 设计

### 根因
- 现状中 `sys_box` 只保存了平铺字段（`station/area/box_address`），没有独立主数据来维护“车间 > 工区 > 安装地点”的层级关系。
- 前端 `Box` 页面此前依赖平铺字典接口思路，无法实现严格的三级联动约束。
- 旧版 `old-box/myvue/src/views/home.vue` 中车间/工区是硬编码，未入库，无法统一维护。

### 设计
- 新增 `sys_location` 表，按 `level(1/2/3) + parent_id` 维护三级关系。
- 新增 `/location` 接口：
  - `GET /location/tree`：返回三级树，供 `Box` 页面联动下拉。
  - `GET /location/list`：返回管理视图数据，供同页 CRUD 展示。
  - `POST /location/save`、`DELETE /location/{id}`：最小可用增删改。
- `Box` 页面改为三级联动：搜索条件与表头顺序统一为 `车间 -> 工区 -> 安装地点`。
- 迁移脚本中：
  - 从 `old-box/myvue/src/views/home.vue` 提取并固化车间/工区种子。
  - 从已有 `sys_box` 去重提取安装地点并挂载到对应工区下。

## 2) 改动文件

### 后端
- `sql/migrations/V20__create_sys_location.sql`
- `src/main/java/com/xjy/shujia/entity/Location.java`
- `src/main/java/com/xjy/shujia/mapper/LocationMapper.java`
- `src/main/java/com/xjy/shujia/service/ILocationService.java`
- `src/main/java/com/xjy/shujia/service/impl/LocationServiceImpl.java`
- `src/main/java/com/xjy/shujia/controller/LocationController.java`
- `src/main/java/com/xjy/shujia/controller/BoxController.java`

### 前端
- `frontend/src/views/Dict.vue`（改为三级地点同页管理）
- `frontend/src/views/Box.vue`（三级联动搜索 + 新增/编辑联动）
- `frontend/src/layouts/MainLayout.vue`（菜单文案“字典配置”改为“地点配置”）

## 3) 迁移说明

### SQL 迁移文件
- 新增：`sql/migrations/V20__create_sys_location.sql`

### 迁移内容
1. 创建 `sys_location` 表及唯一约束 `uq_level_parent_name(level,parent_id,name)`。
2. 写入 old-home 提取的 level=1（车间）与 level=2（工区）基础数据。
3. 从 `sys_box` 去重抽取已有安装地点（`station+area+box_address`）写入 level=3。

### 执行方式
- 若你们已接入迁移框架，执行到 `V20`。
- 若当前为手工执行 SQL，则直接在目标库运行：
  - `sql/migrations/V20__create_sys_location.sql`

## 4) 验证步骤和结果

### 4.1 编译/构建验证
- 后端：`./mvnw -q -DskipTests compile`
  - 结果：通过。
- 前端：`cd frontend && npm run build`
  - 结果：通过。

### 4.2 功能验证步骤
1. 执行 `V20__create_sys_location.sql`。
2. 打开“地点配置”页（`/dict`）：
   - 新增 1 条车间、1 条工区、1 条安装地点。
   - 编辑节点名称。
   - 删除无子节点记录。
3. 打开“配电箱”页（`/box`）：
   - 搜索区按 `车间 -> 工区 -> 安装地点` 顺序显示并联动筛选。
   - 表头按 `车间 -> 工区 -> 安装地点` 顺序显示。
   - 新增/编辑时三级联动可选，保存成功。

### 4.3 结果
- v1.8 五项需求已完成，且满足“最小化改动、不做无关重构”。
